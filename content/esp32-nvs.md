---
title: Ð­Ð½ÐµÑ€Ð³Ð¾Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾Ðµ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ NVS Ð² ESP32
emoji: ðŸ¦‰
created: 2022-06-12
modified: 2022-06-12
tags:
  - ESP32
---

Ð’ ESP32 Ð¼Ð¾Ð¶Ð½Ð¾ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ñ‹ ÐºÐ»ÑŽÑ‡-Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð² ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ð¼ Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ SPI Flash Ð¿Ð°Ð¼ÑÑ‚Ð¸. Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑÐ°Ð¼Ð¸ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ€ ÑÑ‚Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»Ð° Ð¿Ð°Ð¼ÑÑ‚Ð¸ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ [Ñ€Ð°Ð·Ð¼ÐµÑ‚ÐºÐ¸ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¾Ð²](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/partition-tables.html). NVS Ð»ÑƒÑ‡ÑˆÐµ Ð²ÑÐµÐ³Ð¾ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹, Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹ Ð»ÑƒÑ‡ÑˆÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»Ð¾Ð²ÑƒÑŽ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ FAT.

Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ ÑÐ½ÐµÑ€Ð³Ð¾Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¼ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰ÐµÐ¼ Ð¸Ð»Ð¸ NVS (Non-volatile storage) Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð²ÑÐµ Ñ€Ð°Ð·Ð´ÐµÐ»Ñ‹ Ñ„Ð»ÐµÑˆÐºÐ¸ Ñ Ñ‚Ð¸Ð¿Ð¾Ð¼ `data` Ð¸ Ð¿Ð¾Ð´Ñ‚Ð¸Ð¿Ð¾Ð¼ `nvs`.

Ð Ð°Ð·Ð´ÐµÐ» Ñ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÐµÐ¼ `nvs` Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÐµÐ¹ `nvs_open()`, Ð¸Ð»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð² Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÐµÐ¼ Ñ€Ð°Ð·Ð´ÐµÐ»Ð° Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÐµÐ¹ `nvs_open_from_partition()`.

## ÐšÐ»ÑŽÑ‡Ð¸/Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ

ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð´Ð»Ð¸Ð½Ð° ÐºÐ»ÑŽÑ‡Ð° - 15 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð².

Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÐºÐ»ÑŽÑ‡Ð° Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð´Ð½Ð¸Ð¼ Ð¸Ð· Ñ‚Ð¸Ð¿Ð¾Ð²:

- Ñ‡Ð¸ÑÐ»Ð¾ (`uint8_t`, `int8_t`, `uint16_t`, `int16_t`, `uint32_t`, `int32_t`, `uint64_t`, `int64_t`);
- ÑÑ‚Ñ€Ð¾ÐºÐ° Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÑŽÑ‰Ð¸Ð¼ Ð½ÑƒÐ»ÐµÐ²Ñ‹Ð¼ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð¼ (`\0`), Ð½Ðµ Ð±Ð¾Ð»ÑŒÑˆÐµ 4000 Ð±Ð°Ð¹Ñ‚Ð¾Ð²;
- Ð´Ð²Ð¾Ð¸Ñ‡Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ Ð´Ð»Ð¸Ð½Ñ‹ (blob), Ð½Ðµ Ð±Ð¾Ð»ÑŒÑˆÐµ 508 000 Ð±Ð°Ð¹Ñ‚Ð¾Ð² Ð¸Ð»Ð¸ 97.6% Ð¾Ñ‚ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ñ€Ð°Ð·Ð´ÐµÐ»Ð° (4 000 Ð±Ð°Ð¹Ñ‚), Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ‚Ð¾Ð³Ð¾ Ñ‡Ñ‚Ð¾ Ð¼ÐµÐ½ÑŒÑˆÐµ.

ÐšÐ»ÑŽÑ‡Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸.

## ÐŸÑ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð° Ð¸Ð¼ÐµÐ½

Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ñ Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ñ‹Ð¼Ð¸ ÐºÐ»ÑŽÑ‡Ð°Ð¼Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð° Ð¸Ð¼ÐµÐ½ (namespaces). ÐŸÑ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð¾ Ð¸Ð¼ÐµÐ½ ÑÑ‚Ð¾ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ¾Ð²Ð°Ñ Ð¼ÐµÑ‚ÐºÐ° (Ð½Ðµ Ð±Ð¾Ð»ÑŒÑˆÐµ 15 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²) ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð·Ð°Ð´Ð°ÐµÑ‚ÑÑ Ð² Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑÑ… Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ `nvs_open()` Ð¸ `nvs_open_from_partition()`. ÐŸÑ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð° Ð¸Ð¼ÐµÐ½ Ñ Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ñ‹Ð¼Ð¸ Ð¸Ð¼ÐµÐ½Ð°Ð¼Ð¸ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‰Ð¸ÐµÑÑ Ð² Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ñ€Ð°Ð·Ð´ÐµÐ»Ð°Ñ… Ñ„Ð»ÐµÑˆ Ð¿Ð°Ð¼ÑÑ‚Ð¸ ÑÐ²Ð»ÑÑŽÑ‚ÑÑ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸ Ð¸ Ð½Ð¸ÐºÐ°Ðº Ð½Ðµ ÑÐ²ÑÐ·Ð°Ð½Ñ‹.

## NVS Ð˜Ñ‚ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹

Ð˜Ñ‚ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÑŽÑ‚ ÑÐ¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð°Ñ€ ÐºÐ»ÑŽÑ‡-Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ, Ñ…Ñ€Ð°Ð½ÑÑ‰Ð¸Ñ…ÑÑ Ð² NVS, Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¸Ð¼ÐµÐ½Ð¸ Ñ€Ð°Ð·Ð´ÐµÐ»Ð°, Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð° Ð¸Ð¼ÐµÐ½ Ð¸ Ñ‚Ð¸Ð¿Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ….

Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸:

- `nvs_entry_find()` - ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ Ð´ÐµÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ñ€ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð² ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð²Ñ‹Ð·Ð¾Ð²Ð°Ñ…;
- `nvs_entry_next()` - Ð¿Ñ€Ð¾Ð´Ð²Ð¸Ð³Ð°ÐµÑ‚ Ð¸Ñ‚ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ðº ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ Ð¿Ð°Ñ€Ðµ ÐºÐ»ÑŽÑ‡-Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ;
- `nvs_entry_info()` - Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð¿Ð°Ñ€Ðµ ÐºÐ»ÑŽÑ‡-Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ;
- `nvs_release_iterator()` - Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð²Ñ‹Ð·Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ñƒ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð¸Ñ‚ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼.

ÐÐ¸Ð¶Ðµ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½ Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð·Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°ÐµÑ‚ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¾Ðº ESP32 Ð² Ñ†ÐµÐ»Ð¾Ñ‡Ð¸ÑÐ»ÐµÐ½Ð½ÑƒÑŽ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð² NVS.

```c
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/gpio.h"
#include "esp_log.h"
#include "esp_system.h"
#include "nvs_flash.h"
#include "nvs.h"

#define NVS_RESTART_COUNTER "restart_counter"

static const char *TAG = "NVS";
static const gpio_num_t LED_PIN = GPIO_NUM_2;

void app_main(void)
{
    // Setup LED
    gpio_pad_select_gpio(LED_PIN);
    gpio_set_direction(LED_PIN, GPIO_MODE_OUTPUT);
    gpio_set_level(LED_PIN, 1);

    // Initialize NVS
    esp_err_t err = nvs_flash_init();
    if (err == ESP_ERR_NVS_NO_FREE_PAGES || err == ESP_ERR_NVS_NEW_VERSION_FOUND)
    {
        // NVS partition was truncated and needs to be erased
        // Retry nvs_flash_init
        ESP_ERROR_CHECK(nvs_flash_erase());
        err = nvs_flash_init();
    }
    ESP_ERROR_CHECK(err);

    // Open NVS
    nvs_handle_t my_handle;
    ESP_ERROR_CHECK(nvs_open("storage", NVS_READWRITE, &my_handle));

    // Read value
    int32_t restart_counter = 0; // value will default to 0, if not set yet in NVS
    err = nvs_get_i32(my_handle, NVS_RESTART_COUNTER, &restart_counter);
    if (err != ESP_ERR_NVS_NOT_FOUND)
    {
        ESP_ERROR_CHECK(err);
    }
    ESP_LOGI(TAG, "Restart counter: %d", restart_counter);

    // Write value
    restart_counter++;
    ESP_ERROR_CHECK(nvs_set_i32(my_handle, NVS_RESTART_COUNTER, restart_counter));
    ESP_ERROR_CHECK(nvs_commit(my_handle));

    // NVS Close
    nvs_close(my_handle);

    // Restart module
    for (int i = 10; i >= 0; i--)
    {
        ESP_LOGI(TAG, "Restarting in %d seconds...", i);
        vTaskDelay(1000 / portTICK_PERIOD_MS);
    }
    ESP_LOGI(TAG, "Restarting now.");
    gpio_set_level(LED_PIN, 0);
    esp_restart();
}
```